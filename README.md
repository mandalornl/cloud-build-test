# Cloud Build
Create `cloudbuild.yaml` in the root of the project.
```yaml
steps:
  - id: 'Cancel'
    name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e

        mapfile -t ids < <(gcloud builds list --ongoing --region=europe-west4 --format="value(ID)" --sort-by=~createTime)

        if [ "${ids[0]}" == "${BUILD_ID}" ]; then
          for id in "${ids[@]:1}"; do
            if gcloud builds cancel "${id}" --region=europe-west4 --quiet > /dev/null 2>&1; then
              echo "--> Cancelled build ${id}" 
            fi
          done
        fi

  - id: 'Restore'
    name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        storage_uri="gs://${PROJECT_ID}-cloud-build/$(sha256sum pnpm-lock.yaml | cut -d' ' -f1).tar.gz"
        
        echo "${storage_uri}" > storage-uri
        echo "$(date +%s%N)" > cache-id
        
        if gsutil -q stat "${storage_uri}"; then
          mkdir node_modules
          echo "--> Restoring installed packages from ${storage_uri}"
          gsutil -q cp "${storage_uri}" - | tar -xz -C node_modules
        
          if [ -d node_modules/.cache ]; then
            echo "$(ls -lR node_modules/.cache | sha256sum | cut -d' ' -f1)" > cache-id
          fi
        fi

  - id: 'Install & Deploy'
    name: 'node:22'
    env:
      - "FIREBASE_API_KEY=${_FIREBASE_API_KEY}"
      - "FIREBASE_APP_ID=${_FIREBASE_APP_ID}"
      - "FIREBASE_AUTH_DOMAIN=${_FIREBASE_AUTH_DOMAIN}"
      - "FIREBASE_MESSAGING_SENDER_ID=${_FIREBASE_MESSAGING_SENDER_ID}"
      - "FIREBASE_PROJECT_ID=${_FIREBASE_PROJECT_ID}"
      - "FIREBASE_STORAGE_BUCKET=${_FIREBASE_STORAGE_BUCKET}"
    script: |
      #!/usr/bin/env bash
      set -e
      corepack enable
      pnpm install --frozen-lockfile
      npx nuxi generate
      npx firebase-tools --project=$PROJECT_ID deploy --only=hosting --non-interactive

  - id: 'Cache'
    name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        old_cache_id="$(cat cache-id)"
        new_cache_id="$(date +%s%N)"
        
        if [ -d node_modules/.cache ]; then
          new_cache_id="$(ls -lR node_modules/.cache | sha256sum | cut -d' ' -f1)"
        fi
      
        if [ "${new_cache_id}" != "${old_cache_id}" ]; then
          storage_uri="$(cat storage-uri)"
        
          echo "--> Caching installed packages to ${storage_uri}"
          tar -czf /tmp/packages.tar.gz -C node_modules .
          gsutil -q cp /tmp/packages.tar.gz "${storage_uri}"
        fi

timeout: 300s
options:
  logging: CLOUD_LOGGING_ONLY
```

Open `2nd gen` under https://console.cloud.google.com/cloud-build/repositories.
- Click on `Create host connection`.
- Select `GitHub`:
   - Configure your `Region` e.g.`europe-west4`.
   - Enter a name e.g. `GitHub`. 
   - Click on `Connect`.

This will now install the `Google Cloud Build` app on `GitHub`.
- Select `Only select repositories`.
- Choose the repository of the project you want to connect with e.g. `<user>/cloud-build-test`.

Now click on `Link repository` to link the repository to the connection.
- Choose the `Connection` e.g. `GitHub`.
- Choose the `Repository` e.g. `<user>/cloud-build-test`.
- For the `Repository name` just select `Generated`.
- Click on `Link`.

Open https://console.cloud.google.com/cloud-build/triggers.
- Click on `Create trigger`.
- Enter name e.g. `nuxt-generate`.
- Select the region e.g. `europe-west4`.
- Select `Webhook event` under `Event`.
- Select `Use a new secret (generated by Cloud Build)` and click on `Create secret`.
   - Enter a name e.g. `nuxt-generate-webhook-secret`
   - Click on `Create secret`.
- Select `Cloud Build repositories` under `Repository service`.
- Select `2nd gen` under `Repository generation` and select the repository you want to use.
- Select `Branch` under `Revision` and enter the `Branch name` e.g. `deploy`.
- Select `Cloud Build configuration file (yaml or json)` under `Type`.
- Select `Repository` under `Location` and make sure the `Cloud Build configuration file location` is set to `cloudbuild.yaml`.
- Now add `Substitution variables` (optional) which are needed during the build. They'll most likely be the public runtime variables found in `nuxt.config.ts` e.g:
    - _FIREBASE_API_KEY 
    - _FIREBASE_AUTH_DOMAIN 
    - _FIREBASE_PROJECT_ID 
    - _FIREBASE_STORAGE_BUCKET 
    - _FIREBASE_MESSAGING_SENDER_ID 
    - _FIREBASE_APP_ID
- Under `Service account` select the account that ends with `<project-id>@appspot.gserviceaccount.com`.
- Click on `Create`.

## Webhook URL
Under `Webhook URL preview` you will find the URL you need during the `GitHub` configuration step e.g.:
```
https://cloudbuild.googleapis.com/v1/projects/<project-id>/locations/<region>/triggers/<trigger-name>:webhook?key=<key>&secret=<secret>&trigger=<trigger-name>&projectId=<project-id>
```

# Cloud Storage
Open https://console.cloud.google.com/storage/browser.
- Click on `Create`.
- Enter the name `<project-id>-cloud-build`.
- Select `Region` and choose e.g. `europe-west4` under `Choose where to store your data`.
- Select `Set a default class` and choose `Standard` under `Choose how to store your data`.
- Make sure to enable `Enfore public access prevention on this bucket` under `Choose how to control access to objects`.
- Select `Uniform` under `Access control`.
- Unselect all under `Choose how to protect object data`.
- Click on `Create`.

## Lifecycle
- Now open the bucket and click on `Add a rule` under `Lifecycle`.
- Select `Delete object` under `Select an action`.
- Select `Age` and enter `30` days under `Select object conditions`.
- Click on `Create`.

# GitHub
Create `deploy.yml` under `.github/workflows` in the root of the project.
```yaml
name: Deploy to Firebase Hosting
on:
  push:
    branches:
      - deploy
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Call webhook URL
        run: |
          curl -X POST '${{ vars.WEBHOOK_URL }}' \
            -H 'Content-Type: application/json' \
            -d '{}'
```

- Open `Actions` under `Secrets and variables` under `Settings`.
- Open the `Variables` tab and click `New Repository variable`.
- Create the variable `WEBHOOK_URL` with the `Cloud Build` [webhook URL](#webhook-url).